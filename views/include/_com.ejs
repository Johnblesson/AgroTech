<link rel="stylesheet" href="./css/community.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
    .user-comment-photo {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        margin-right: 10px;
    }
</style>
<div class="community-container">
    <h1>AgroTech Community</h1>

    <!-- Post Form -->
    <div class="post-form">
        <form id="post-form">
            <textarea name="post" rows="4" placeholder="Share your thoughts..."></textarea>
            <button type="submit">Post</button>
        </form>
    </div>

    <!-- Display Posts -->
    <% posts.forEach(post => { %>
        <div class="post-card"> <!-- Changed from 'post' to 'post-card' for clarity -->
            <div class="post-header">
                <img src="<%= post.createdBy.photo %>" alt="User Photo">
                <a href="/user/<%= post.createdBy._id %>"><strong><%= post.createdBy.fullname %></strong></a>
                <small> - <%= post.createdAt.toLocaleDateString() %></small>
            </div>
            <p class="post-content"><%= post.post %></p>

            <!-- Like and Comment Section -->
            <div class="like-comment-section">
                <!-- Add Comment Input at the Top -->
                <form class="add-comment-form" data-post-id="<%= post._id %>">
                    <!-- <input type="text" name="comment" placeholder="Add a comment..." required> -->
                    <img src="<%= user.photo %>" alt="User Photo" class="user-comment-photo">
                    <input type="text" name="comment" placeholder="Comment as <%= user.fullname  %>" required>
                    <button type="submit">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>

                <!-- Toggle Comments Button -->
                <button class="toggle-comments-btn" onclick="toggleComments('<%= post._id %>')">
                    <i class="fas fa-chevron-down"></i>
                </button>

                <!-- Display Comments -->
                <div class="comments" id="comments-<%= post._id %>" style="display: none;">
                    <% post.comments.forEach(comment => { %>
                        <div class="comment">
                            <div class="comment-header">
                                <img src="<%= comment.commentedBy.photo %>" alt="User Photo" class="user-photo">
                                <strong class="comment-author"><%= comment.commentedBy.fullname %></strong>
                            </div>
                            <p class="comment-text"><%= comment.text %></p>
                        </div>
                    <% }) %>
                </div>

               <!-- Like and Comment Buttons at the Bottom -->
               <div class="like-comment-buttons">
                    <form class="like-form" data-post-id="<%= post._id %>">
                        <button type="submit">
                            <i class="fas fa-thumbs-up"></i> <span id="like-count-<%= post._id %>"><%= post.likes.length %></span>
                        </button>
                    </form>
                    <button onclick="toggleComments('<%= post._id %>')">
                        <i class="fas fa-comment"></i> <span id="comment-count-<%= post._id %>"><%= post.comments.length %></span>
                    </button>
                </div>
            </div>
        </div>
    <% }) %>

    <!-- Pagination -->
    <div class="pagination">
        <% if (currentPage > 1) { %>
            <a href="?page=<%= currentPage - 1 %>" class="prev-button">Previous</a>
        <% } %>

        <% for (let i = 1; i <= totalPages; i++) { %>
            <a href="?page=<%= i %>" class="page-number <%= i === currentPage ? 'active' : '' %>"><%= i %></a>
        <% } %>

        <% if (currentPage < totalPages) { %>
            <a href="?page=<%= currentPage + 1 %>" class="next-button">Next</a>
        <% } %>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();

    // Submit post form using AJAX
    document.getElementById('post-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const postText = e.target.elements.post.value;
        try {
            const response = await fetch('/community/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ post: postText })
            });
            if (response.ok) {
                e.target.elements.post.value = ''; // Clear the textarea
            }
        } catch (error) {
            console.error('Error creating post:', error);
        }
    });

    // Submit like form using AJAX
    document.querySelectorAll('.like-form').forEach(form => {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const postId = e.target.dataset.postId;
            try {
                const response = await fetch(`/community/${postId}/like`, { method: 'POST' });
                if (!response.ok) console.error('Error liking post');
            } catch (error) {
                console.error('Error liking post:', error);
            }
        });
    });

    // Submit comment form using AJAX
    document.querySelectorAll('.add-comment-form').forEach(form => {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const postId = e.target.dataset.postId;
            const commentText = e.target.elements.comment.value;
            try {
                const response = await fetch(`/community/${postId}/comment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comment: commentText })
                });
                if (response.ok) {
                    e.target.elements.comment.value = ''; // Clear the comment input
                }
            } catch (error) {
                console.error('Error commenting on post:', error);
            }
        });
    });

    // Toggle comments section
    function toggleComments(postId) {
        const commentsSection = document.getElementById(`comments-${postId}`);
        const toggleButton = commentsSection.previousElementSibling.querySelector('.fas');

        if (commentsSection.style.display === "none" || !commentsSection.style.display) {
            commentsSection.style.display = "block";
            toggleButton.classList.replace("fa-chevron-down", "fa-chevron-up");
        } else {
            commentsSection.style.display = "none";
            toggleButton.classList.replace("fa-chevron-up", "fa-chevron-down");
        }
    }

    // Socket.IO events
    socket.on('newPost', (post) => {
        // Insert new post at the top of the community-container
    });

    socket.on('postLiked', ({ postId, likes }) => {
        document.getElementById(`like-count-${postId}`).innerText = likes;
    });

    socket.on('newComment', ({ postId, comment }) => {
        // Append the new comment to the comments section
        const commentsSection = document.getElementById(`comments-${postId}`);
        const commentHtml = `
            <div class="comment">
                <div class="comment-header">
                    <img src="${comment.commentedBy.photo}" alt="User Photo" class="user-photo">
                    <strong class="comment-author">${comment.commentedBy.fullname}</strong>
                </div>
                <p class="comment-text">${comment.text}</p>
            </div>
        `;
        commentsSection.insertAdjacentHTML('beforeend', commentHtml);
        document.getElementById(`comment-count-${postId}`).innerText++;
    });
</script>